<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Node Auth App - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: Inter, sans-serif;
            background: #f3f4f6;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-100 flex flex-col items-center justify-center">
    <nav class="w-full max-w-2xl flex justify-between items-center py-4 px-6 bg-white shadow rounded-t-xl">
        <span class="text-lg font-bold text-indigo-700">NodeAuthApp</span>
        <div>
            <a href="#" id="profile-link" class="text-gray-600 hover:underline mr-4">Profile</a>
            <a href="#" id="logout-link" class="text-red-600 hover:underline">Logout</a>
        </div>
    </nav>
    <main class="w-full max-w-2xl bg-white shadow rounded-b-xl p-8 flex flex-col items-center">
        <h1 id="welcome" class="text-3xl font-bold text-gray-800 mb-4">Welcome!</h1>
        <div class="w-full flex flex-col md:flex-row gap-6 justify-center mb-8">
            <button id="edit-profile-btn"
                class="flex-1 bg-indigo-50 border border-indigo-200 rounded-lg p-6 text-center hover:bg-indigo-100 transition">Edit
                Profile</button>
            <button id="view-users-btn"
                class="flex-1 bg-green-50 border border-green-200 rounded-lg p-6 text-center hover:bg-green-100 transition">View
                Users</button>
        </div>
        <div id="dashboard-content" class="w-full"></div>
    </main>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal"
        class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Edit Profile</h2>
            <form id="edit-profile-form" class="space-y-4">
                <div><label class="block text-sm font-medium">Username</label>
                    <input type="text" name="username" required class="mt-1 block w-full px-4 py-2 border rounded-lg">
                </div>
                <div><label class="block text-sm font-medium">Email</label>
                    <input type="email" name="email" required class="mt-1 block w-full px-4 py-2 border rounded-lg">
                </div>
                <div><label class="block text-sm font-medium">New Password</label>
                    <input type="password" name="password" placeholder="Leave blank to keep current"
                        class="mt-1 block w-full px-4 py-2 border rounded-lg">
                </div>
                <button type="submit" class="w-full py-2 rounded-lg text-white bg-indigo-600">Save Changes</button>
                <button type="button" id="close-profile-modal"
                    class="w-full py-2 mt-2 rounded-lg text-gray-700 bg-gray-200">Cancel</button>
            </form>
            <div id="profile-msg" class="mt-2 text-sm"></div>
        </div>
    </div>

    <!-- Users List Modal -->
    <div id="users-list-modal"
        class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-2xl">
            <h2 class="text-xl font-bold mb-4">Registered Users</h2>
            <div id="users-table"></div>
            <button type="button" id="close-users-modal"
                class="w-full py-2 mt-4 rounded-lg text-gray-700 bg-gray-200">Close</button>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div id="user-detail-modal"
        class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">User Details</h2>
            <div id="user-detail-content"></div>
            <button type="button" id="close-detail-modal"
                class="w-full py-2 mt-4 rounded-lg text-gray-700 bg-gray-200">Close</button>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:4000/api';
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'index.html';
        const welcome = document.getElementById('welcome');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const editProfileModal = document.getElementById('edit-profile-modal');
        const closeProfileModal = document.getElementById('close-profile-modal');
        const editProfileForm = document.getElementById('edit-profile-form');
        const profileMsg = document.getElementById('profile-msg');
        const viewUsersBtn = document.getElementById('view-users-btn');
        const usersListModal = document.getElementById('users-list-modal');
        const closeUsersModal = document.getElementById('close-users-modal');
        const usersTable = document.getElementById('users-table');
        const userDetailModal = document.getElementById('user-detail-modal');
        const userDetailContent = document.getElementById('user-detail-content');
        const closeDetailModal = document.getElementById('close-detail-modal');
        const logoutLink = document.getElementById('logout-link');

        // Fetch profile
        fetch(API_URL + '/profile', { headers: { Authorization: 'Bearer ' + token } })
            .then(r => r.json())
            .then(data => {
                if (data.user) {
                    welcome.innerHTML = `Welcome, <span class="text-indigo-600">${data.user.username}</span>!`;
                    editProfileForm.username.value = data.user.username;
                    editProfileForm.email.value = data.user.email;
                } else {
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                }
            });

        logoutLink.onclick = () => {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        };

        editProfileBtn.onclick = () => { editProfileModal.classList.remove('hidden'); };
        closeProfileModal.onclick = () => { editProfileModal.classList.add('hidden'); profileMsg.textContent = ''; };
        editProfileForm.onsubmit = async (e) => {
            e.preventDefault();
            profileMsg.textContent = '';
            const formData = Object.fromEntries(new FormData(editProfileForm));
            try {
                const res = await fetch(API_URL + '/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
                    body: JSON.stringify(formData)
                });
                const json = await res.json();
                if (json.message === 'Profile updated') {
                    profileMsg.textContent = 'Profile updated successfully!';
                    profileMsg.className = 'text-green-600';
                    setTimeout(() => { editProfileModal.classList.add('hidden'); location.reload(); }, 1200);
                } else {
                    profileMsg.textContent = json.message || 'Update failed.';
                    profileMsg.className = 'text-red-600';
                }
            } catch (err) {
                profileMsg.textContent = 'Server error.';
                profileMsg.className = 'text-red-600';
            }
        };

        viewUsersBtn.onclick = async () => {
            usersTable.innerHTML = '<div>Loading...</div>';
            usersListModal.classList.remove('hidden');
            try {
                const res = await fetch(API_URL + '/users', { headers: { Authorization: 'Bearer ' + token } });
                const json = await res.json();
                if (json.users) {
                    let html = '<table class="min-w-full text-sm"><thead><tr><th class="px-4 py-2">Username</th><th class="px-4 py-2">Email</th><th class="px-4 py-2">Joined</th><th></th></tr></thead><tbody>';
                    for (const user of json.users) {
                        html += `<tr><td class="px-4 py-2">${user.username}</td><td class="px-4 py-2">${user.email}</td><td class="px-4 py-2">${user.created_at}</td><td><button class="text-indigo-600 underline" onclick="showUserDetail(${user.id})">Details</button></td></tr>`;
                    }
                    html += '</tbody></table>';
                    usersTable.innerHTML = html;
                } else {
                    usersTable.innerHTML = '<div>No users found.</div>';
                }
            } catch (err) {
                usersTable.innerHTML = '<div>Server error.</div>';
            }
        };
        closeUsersModal.onclick = () => { usersListModal.classList.add('hidden'); };

        window.showUserDetail = async function (id) {
            userDetailContent.innerHTML = '<div>Loading...</div>';
            userDetailModal.classList.remove('hidden');
            try {
                const res = await fetch(API_URL + '/users/' + id, { headers: { Authorization: 'Bearer ' + token } });
                const json = await res.json();
                if (json.user) {
                    userDetailContent.innerHTML = `<div><strong>Username:</strong> ${json.user.username}</div><div><strong>Email:</strong> ${json.user.email}</div><div><strong>Joined:</strong> ${json.user.created_at}</div>`;
                } else {
                    userDetailContent.innerHTML = '<div>User not found.</div>';
                }
            } catch (err) {
                userDetailContent.innerHTML = '<div>Server error.</div>';
            }
        };
        closeDetailModal.onclick = () => { userDetailModal.classList.add('hidden'); };
    </script>
</body>

</html>